{% extends "static/lm.njk" %}


{% set activePage="banking" %}
{% set headingCategory="Dashboard" %}
{% set headingHeading="Banking" %}
{% set title="Banking" %}
{% set reverse=url("banking:index", args=[user.slug,]) %}


{% block head %}
    <script src="{{ static('app/js/line_chart.js') }}" api-data="{{ url('banking:api_data_index', args=[user.slug,]) }}"></script>
    <script src="{{ static('app/js/pie_chart.js') }}" api-data="{{ url('banking:api_data_categories', args=[user.slug,]) }}"></script>
{% endblock %}


{% block chart %}
    <div class="hs-3"></div>
    <canvas class="console-target is-hidden console_accounts" id="line_chart"></canvas>
    <canvas class="console-target console_stats console_categories console_timespans" id="pie_chart"></canvas>
    <div class="hs-3"></div>
    <hr class="hr"> 
{% endblock %}
 

{% block main %}

    
    {% import "modules/table.njk" as table %}
    {% import "modules/buttons.njk" as buttons %}
    {% import "modules/cards.njk" as cards %}
    {% import "modules/timespan.njk" as timespan %}

    
    <div class="hs-1"></div>

    
    <div class="divider">
        <div class="divider--content"> 
            <div class="console" data-toggle="buttons">
                <label class="console--button active" data-target=".console_stats">
                    <input type="radio">Stats
                </label>
                <label class="console--button" data-target=".console_accounts">
                    <input type="radio">Accounts
                </label>
                <label class="console--button" data-target=".console_categories">
                    <input type="radio">Categories
                </label>
                <label class="console--button" data-target=".console_timespans">
                    <input type="radio">Time Spans
                </label>
            </div>
        </div>
    </div>


    <div class="hs-3"></div>

    
    <div class="wrapper console-target console_stats">
        <div class="table-heading">
            <h2 class="table-heading--heading">Stats</h2>
            {{ buttons.buttonLink(text="Update", url=url("banking:update_stats", args=[user.slug,])) }}
        </div>
        <hr class="hr"> 
        <div class="card-deck">
            {% set value %}
                {{ movie.get_values(user, ["b",])["b"] }} {{ user.currency }}
            {% endset %}
            {{ cards.statsCard(heading="Total", value=value) }}
        </div>
        {% for ts in timespans %}
            {% if ts.start_date and ts.is_active %}
                <div class="hs-3"></div>
                <div class="table-heading">
                    <h3 class="table-heading--heading">{{ ts.name }}</h3>
                </div>
                <hr class="hr"></hr>
                <div class="card-deck">
                    {% for data in movie.get_values(user, ["b",], ts) %}
                        {% set heading %}
                            {{ data.start_date }}-{{ data.end_date }}
                        {% endset %}
                        {% set value %}
                            Change: {{ data.b }}
                        {% endset %}
                        {{ cards.statsCard(heading=heading, value=value, small=True) }}
                    {% endfor %}
                </div>
            {% endif %}
        {% endfor %}
    </div>


    <div class="wrapper console-target is-hidden console_accounts">
        <div class="table-heading">
            <h2 class="table-heading--heading">Accounts</h2>  
            {{ buttons.buttonModal(text="Add Account", dataTarget="#addAccount") }}
            <div class="placeholder"></div>
            {{ buttons.buttonModal(text="Delete Account", dataTarget="#deleteAccount", class="btn-danger") }}     
        </div>
        <table class="table">
            {{ table.head(["Account", "Balance", "Action"]) }}
            <tbody class="table--body">
                {% for account, movie in accounts_movies %}
                    {% set name %}
                        <a href="{{ url('banking:account', args=[user.slug, account.slug,]) }}" class="link-bold">{{ account.name }}</a>
                    {% endset %}
                    {% set tablebuttons %}
                        <div class="d-flex flex-row">
                            {{ buttons.buttonModal(text="Deposit / Withdraw", dataTarget="#addChange", data="accountpk=" + account.pk|string ) }}
                            <div class="placeholder"></div>
                            {% set data %}
                                {% raw %} { {% endraw %}
                                    'pk': '{{ account.pk }}', 
                                    'name': '{{ account.name }}'
                                {% raw %} } {% endraw %}
                            {% endset %}
                            {{ buttons.buttonModalNew(text="Edit", dataTarget="#editAccount", data=data) }}  
                        </div> 
                    {% endset %}
                    {% set balance %}
                        {{ movie.get_values(user, ["b",])["b"] }} {{ user.currency }}
                    {% endset %}
                    {{ table.row([name | safe, balance, tablebuttons | safe]) }}
                {% endfor %}
            </tbody>
        </table>
    </div>

 
    <div class="wrapper console-target is-hidden console_categories">
        <div class="table-heading">
            <h2 class="table-heading--heading">Categories</h2>  
            {{ buttons.buttonModal(text="Add Category", dataTarget="#addCategory") }}
            <div class="placeholder"></div>
            {{ buttons.buttonModal(text="Delete Category", dataTarget="#deleteCategory", class="btn-danger") }}       
        </div>
        <table class="table">
            {{ table.head(["Category", "Description", "Action"]) }}
            <tbody class="table--body">
                {% for category in categories %}
                    {% set name %}
                        <a href="{{ url('banking:category', args=[user.slug, category.slug, ]) }}" class="link-bold">{{ category.name }}</a>
                    {% endset %} 
                    {% set tablebuttons %}
                        <div class="d-flex flex-row">
                            {% set data %}
                                {% raw %} { {% endraw %}
                                    'pk': '{{ category.pk }}', 
                                    'name': '{{ category.name }}',
                                    'description': '{{ category.description }}'
                                {% raw %} } {% endraw %}
                            {% endset %}
                            {{ buttons.buttonModalNew(text="Edit", dataTarget="#editCategory", data=data) }}
                        </div>  
                    {% endset %} 
                    {{ table.row([name | safe, category.description, tablebuttons | safe]) }}
                {% endfor %}
            </tbody>
        </table>
    </div>
    

    <div class="wrapper console-target is-hidden console_timespans">
        <div class="table-heading">
            <h2 class="table-heading--heading">Timespans</h2>  
        </div>
        <hr class="hr">
        <div class="hs-1"></div>
        <ul class="timespans">
            {% for ts in timespans %} 
                {{ timespan.timespan(ts, depot, url('banking:set_timespan', args=[user.slug,]), url('banking:delete_timespan', args=[user.slug,]), reverse, csrf_token)}}
            {% endfor %}
            {{ timespan.createTimespan(False, url('banking:add_timespan', args=[user.slug,]), reverse, csrf_token) }}
        </ul>
    </div>


{% endblock %}

 
{% block modals %}
    {% import "modules/banking/modals.njk" as modals %}
    {{ modals.addAccountModal(user, depot.pk, csrf_token, reverse) }}
    {{ modals.editAccountModal(user, csrf_token, reverse) }}
    {{ modals.deleteAccountModal(user, accounts, csrf_token, reverse) }}
    {{ modals.addChangeModal(user, url("banking:add_change", args=[user.slug,]), categories, csrf_token, reverse) }}
    {{ modals.addCategoryModal(user, csrf_token, reverse) }}
    {{ modals.editCategoryModal(user, csrf_token, reverse) }}
    {{ modals.deleteCategoryModal(user, categories, csrf_token, reverse) }}
{% endblock %}
